<!doctype html>
<html lang="kk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>–ë—ñ—Ä –∞–¥–∞–º“ì–∞ “ì–∞–Ω–∞</title>

  <style>
    :root{
      --bg0:#050508;
      --gold:#ffd26a;
      --gold2:#ffb84d;
      --peach:#ffcfb8;

      --white: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --muted2: rgba(255,255,255,.42);

      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);

      --radius: 22px;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --shadow2: 0 10px 26px rgba(0,0,0,.35);
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "SF Pro Display", "Helvetica Neue", Arial, sans-serif;
      background:
        radial-gradient(900px 520px at 50% -10%, rgba(255,210,106,.10), transparent 60%),
        radial-gradient(800px 560px at 20% 10%, rgba(255,207,184,.08), transparent 60%),
        radial-gradient(1200px 900px at 50% 0%, #12122a 0%, var(--bg0) 55%, #000 100%);
      color: var(--white);
      overflow: hidden;
    }

    @media (prefers-reduced-motion: reduce){
      *{ animation-duration: .001ms !important; animation-iteration-count: 1 !important; transition-duration: .001ms !important; scroll-behavior: auto !important; }
    }

    .app{
      position: relative;
      width: 100%;
      height: 100vh;
      height: 100svh;
      overflow: hidden;
    }

    .vignette{
      position:absolute;
      inset:0;
      pointer-events:none;
      z-index: 1;
      background:
        radial-gradient(700px 420px at 50% 10%, transparent 40%, rgba(0,0,0,.50) 100%),
        linear-gradient(180deg, rgba(0,0,0,.10), rgba(0,0,0,.35));
      opacity:.65;
    }

    .topbar{
      position:absolute;
      top: calc(12px + var(--safe-top));
      left: 12px;
      right: 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      z-index: 80;
      pointer-events:none;
    }
    .brand{
      pointer-events:auto;
      font-size: 12px;
      letter-spacing: .16em;
      text-transform: uppercase;
      color: var(--muted2);
      user-select:none;
    }
    .mute{
      pointer-events:auto;
      width: 44px;
      height: 44px;
      display:grid;
      place-items:center;
      border-radius: 16px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: var(--shadow2);
      cursor:pointer;
      user-select:none;
    }
    .mute:active{ transform: scale(.98); }

    .screens{
      width: 500vw;
      height: 100%;
      display:flex;
      transform: translate3d(0,0,0);
      transition: transform 560ms cubic-bezier(.2,.9,.2,1);
      will-change: transform;
    }

    section.screen{
      width: 100vw;
      height: 100%;
      position: relative;
      padding: calc(24px + var(--safe-top)) 16px calc(20px + var(--safe-bottom)) 16px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      gap: 16px;
      z-index: 2;
    }

    .thumb{
      width:100%;
      padding-bottom: calc(10px + var(--safe-bottom));
      display:flex;
      flex-direction:column;
      gap: 10px;
      align-items:center;
      justify-content:flex-end;
    }

    .navrow{
      width: min(520px, 92vw);
      display:flex;
      gap: 10px;
    }
    .navrow .btn{ width: 100%; }

    .copy{
      text-align:center;
      max-width: 520px;
      margin: 0 auto;
    }
    .copy h1{
      font-size: clamp(26px, 6vw, 34px);
      line-height: 1.12;
      margin: 0 0 10px 0;
      letter-spacing: -0.02em;
    }
    .copy p{
      margin: 0;
      font-size: 16px;
      line-height: 1.5;
      color: var(--muted);
    }
    .subtle{
      margin-top: 10px;
      font-size: 13px;
      color: rgba(255,255,255,.55);
      letter-spacing: .01em;
    }

    .btn{
      width: min(520px, 92vw);
      height: 54px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      color: var(--white);
      font-size: 16px;
      font-weight: 900;
      letter-spacing: .01em;
      cursor: pointer;
      box-shadow: var(--shadow2);
      transition: transform .12s ease, filter .2s ease, background .2s ease;
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      position:relative;
      overflow:hidden;
    }
    .btn:active{ transform: scale(.98); }

    .btn-primary{
      background: linear-gradient(180deg, rgba(255,210,106,.20), rgba(255,184,77,.10));
      border: 1px solid rgba(255,210,106,.35);
      box-shadow: 0 12px 34px rgba(255,184,77,.16), var(--shadow2);
    }
    .btn-primary.glow{ filter: drop-shadow(0 0 18px rgba(255,210,106,.22)); }

    .btn-green{
      background: linear-gradient(180deg, rgba(80,255,170,.20), rgba(40,255,140,.10));
      border: 1px solid rgba(80,255,170,.35);
      box-shadow: 0 12px 34px rgba(80,255,170,.12), var(--shadow2);
      filter: drop-shadow(0 0 18px rgba(80,255,170,.18));
    }
    .btn-secondary{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.78);
      font-weight: 900;
    }

    .shimmer::after{
      content:"";
      position:absolute;
      inset:-60% -60%;
      background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,.20) 45%, rgba(255,255,255,.05) 55%, transparent 100%);
      transform: rotate(14deg) translateX(-60%);
      animation: shimmer 2.6s ease-in-out infinite;
      pointer-events:none;
    }
    @keyframes shimmer{
      0%{ transform: rotate(14deg) translateX(-60%); opacity:0; }
      15%{ opacity:.65; }
      100%{ transform: rotate(14deg) translateX(60%); opacity:0; }
    }
    @media (prefers-reduced-motion: reduce){
      .shimmer::after{ animation:none; display:none; }
    }

    .screen .fadein{
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 520ms ease, transform 520ms ease;
    }
    .screen.active .fadein{
      opacity: 1;
      transform: translateY(0);
    }

    /* ===== Screen 1 ===== */
    .hero{
      position:relative;
      flex: 1;
      display:grid;
      place-items:center;
      padding-top: 20px;
      z-index: 2;
    }
    .glass-circle{
      width: 240px;
      height: 240px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.18), rgba(255,255,255,.06));
      border: 1px solid rgba(255,255,255,.20);
      box-shadow: var(--shadow);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      display:grid;
      place-items:center;
      position:relative;
      overflow:hidden;
      animation: floaty 3.6s ease-in-out infinite;
    }
    @keyframes floaty{
      0%,100%{ transform: translate3d(0,0,0); }
      50%{ transform: translate3d(0,-8px,0); }
    }
    @media (prefers-reduced-motion: reduce){
      .glass-circle{ animation:none; }
    }
    .glass-circle::after{
      content:"";
      position:absolute;
      inset:-60px -60px auto auto;
      width: 180px;
      height: 180px;
      background: radial-gradient(circle, rgba(255,210,106,.22), transparent 65%);
      transform: rotate(18deg);
      pointer-events:none;
    }
    .avatar{
      width: 160px;
      height: 160px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.35);
      object-fit: cover;
      box-shadow: 0 18px 50px rgba(0,0,0,.35);
    }

    .flowers{
      position:absolute;
      inset:0;
      overflow:hidden;
      pointer-events:none;
      z-index: 1;
    }
    .flower{
      position:absolute;
      top:-90px;
      opacity: .78;
      filter: blur(.2px) drop-shadow(0 8px 18px rgba(0,0,0,.25));
      animation: fall linear infinite;
      transform: translate3d(0,0,0);
      will-change: transform, opacity;
    }
    @keyframes fall{
      0%{ transform: translate3d(0,-90px,0) rotate(0deg); opacity:0; }
      10%{ opacity:.8; }
      100%{ transform: translate3d(0, calc(100vh + 140px), 0) rotate(420deg); opacity:0; }
    }

    /* ===== Screen 2 Memories ===== */
    .memories{
      position:relative;
      flex: 1;
      border-radius: var(--radius);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      box-shadow: var(--shadow2);
      touch-action: pan-y;
      z-index: 2;
    }
    .carousel{
      height: 100%;
      display:flex;
      transform: translate3d(0,0,0);
      transition: transform 520ms cubic-bezier(.2,.9,.2,1);
      will-change: transform;
    }
    .slide{
      min-width: 100%;
      height: 100%;
      position: relative;
      background: #000;
      overflow:hidden;
    }
    /* background blurred cover */
    .slide img.bg{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit: cover;
      filter: blur(18px) brightness(.70) saturate(1.05) contrast(1.05);
      transform: scale(1.12);
    }
    /* foreground keeps full photo visible */
    .slide img.fg{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit: contain;
      filter: saturate(1.06) contrast(1.05);
      transform: translate3d(0,0,0);
    }
    .slide.kenburns img.fg{
      animation: kenburns 6s ease-in-out infinite alternate;
      transform-origin: center;
    }
    @keyframes kenburns{
      from{ transform: scale(1.00) translate3d(0,0,0); }
      to{ transform: scale(1.06) translate3d(0,0,0); }
    }
    @media (prefers-reduced-motion: reduce){
      .slide.kenburns img.fg{ animation:none; }
    }

    .memories::after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(0,0,0,.08), rgba(0,0,0,.20) 55%, rgba(0,0,0,.62));
      pointer-events:none;
      z-index: 3;
    }

    .dots{
      position:absolute;
      left:0; right:0;
      bottom: calc(84px + var(--safe-bottom));
      display:flex;
      justify-content:center;
      gap: 8px;
      z-index: 6;
      pointer-events:auto;
    }
    .dot{
      width: 7px; height: 7px;
      border-radius: 999px;
      background: rgba(255,255,255,.28);
      border: 1px solid rgba(255,255,255,.16);
      transition: transform .2s ease, background .2s ease;
    }
    .dot.active{
      background: rgba(255,210,106,.85);
      border-color: rgba(255,210,106,.55);
      box-shadow: 0 0 16px rgba(255,210,106,.28);
      transform: scale(1.25);
    }

    .hint{
      position:absolute;
      top: 14px;
      left: 14px;
      right: 14px;
      z-index: 7;
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.14);
      padding: 10px 12px;
      border-radius: 16px;
      font-size: 13px;
      color: rgba(255,255,255,.85);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .hint button{
      margin-left: 10px;
      border: none;
      background: rgba(255,255,255,.10);
      color: rgba(255,255,255,.9);
      border-radius: 10px;
      padding: 6px 10px;
      cursor:pointer;
      font-weight: 800;
    }

    .heart-wrap{
      position:absolute;
      left:0; right:0;
      bottom: calc(12px + var(--safe-bottom));
      display:flex;
      justify-content:center;
      z-index: 7;
      pointer-events:auto;
    }
    .heart-btn{
      width: min(520px, 92vw);
      height: 58px;
      border-radius: 20px;
      background: linear-gradient(180deg, rgba(255,207,184,.20), rgba(255,207,184,.10));
      border: 1px solid rgba(255,207,184,.30);
      box-shadow: 0 14px 34px rgba(255,207,184,.10), var(--shadow2);
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      font-weight: 950;
      cursor:pointer;
      user-select:none;
      letter-spacing: -.01em;
      position: relative;
      overflow:hidden;
    }
    .heart-btn:active{ transform: scale(.985); }
    .heart-btn.pulsefx{ animation: btnpulse .42s ease-out 1; }
    @keyframes btnpulse{
      0%{ transform: scale(1); }
      35%{ transform: scale(1.015); }
      100%{ transform: scale(1); }
    }

    .particles{
      position:absolute;
      inset:0;
      pointer-events:none;
      z-index: 8;
    }
    .pheart{
      position:absolute;
      font-size: 16px;
      opacity:.95;
      animation: fly 900ms ease-out forwards;
      filter: drop-shadow(0 8px 18px rgba(0,0,0,.25));
    }
    @keyframes fly{
      0%{ transform: translate3d(0,0,0) scale(.8); opacity:0; }
      10%{ opacity:.95; }
      100%{ transform: translate3d(var(--dx), var(--dy), 0) scale(1.1); opacity:0; }
    }
    @media (prefers-reduced-motion: reduce){
      .pheart{ animation-duration: 1ms; }
    }

    /* ===== Screen 3 Trap ===== */
    .trap-area{
      flex: 1;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap: 18px;
      position:relative;
      z-index: 2;
    }
    .trap-buttons{
      position:relative;
      height: 190px;
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .yes{
      position:absolute;
      left: 16px;
      right: 16px;
      bottom: 16px;
    }
    .no{
      position:absolute;
      top: 22px;
      left: 18px;
      width: 120px;
      height: 44px;
      border-radius: 14px;
      font-size: 14px;
    }
    .tooltip{
      position:absolute;
      top: 14px;
      right: 14px;
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.14);
      padding: 10px 12px;
      border-radius: 16px;
      font-size: 13px;
      color: rgba(255,255,255,.85);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      opacity:0;
      transform: translateY(-6px);
      transition: opacity .2s ease, transform .2s ease;
      pointer-events:none;
      z-index: 5;
    }
    .tooltip.show{ opacity:1; transform: translateY(0); }
    .screen.shake{ animation: shake 420ms ease-in-out 1; }
    @keyframes shake{
      0%{ transform: translate3d(0,0,0); }
      20%{ transform: translate3d(2px,-1px,0); }
      40%{ transform: translate3d(-2px,1px,0); }
      60%{ transform: translate3d(1px,2px,0); }
      80%{ transform: translate3d(-1px,-2px,0); }
      100%{ transform: translate3d(0,0,0); }
    }

    /* ===== Screen 4 Scanner base ===== */
    .scanner-wrap{
      flex: 1;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      gap: 12px;
      z-index: 2;
    }
    .frame{
      width: min(520px, 92vw);
      height: 280px;
      border-radius: 26px;
      position:relative;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.16);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .grid{
      position:absolute; inset:0;
      background-image:
        linear-gradient(rgba(255,255,255,.07) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,.07) 1px, transparent 1px);
      background-size: 28px 28px;
      opacity: .35;
      pointer-events:none;
    }
    .scanline{
      position:absolute;
      left:0; right:0;
      height: 3px;
      top: 10%;
      background: linear-gradient(90deg, transparent, rgba(255,210,106,.80), transparent);
      filter: drop-shadow(0 0 14px rgba(255,210,106,.28));
      opacity:0;
      transform: translateY(0);
      will-change: transform, opacity;
    }
    .status{
      width: min(520px, 92vw);
      text-align:center;
      color: rgba(255,255,255,.82);
      min-height: 22px;
      font-size: 14px;
      letter-spacing: .01em;
    }
    .glitch{ animation: glitch 520ms ease-in-out 1; }
    @keyframes glitch{
      0%{ transform: translate3d(0,0,0); }
      20%{ transform: translate3d(2px, -1px, 0); }
      40%{ transform: translate3d(-2px, 1px, 0); }
      60%{ transform: translate3d(1px, 2px, 0); }
      80%{ transform: translate3d(-1px, -2px, 0); }
      100%{ transform: translate3d(0,0,0); }
    }

    /* ===== Screen 5 Map ===== */
    .mapcard{
      flex: 1;
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      box-shadow: var(--shadow2);
      overflow:hidden;
      position:relative;
      display:flex;
      flex-direction:column;
      z-index: 2;
    }
    .map-embed{
      flex:1;
      background: #0a0a12;
      position:relative;
      overflow:hidden;
    }
    .gmap{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      border:0;
      filter: grayscale(.20) contrast(1.10) brightness(.90) saturate(1.10);
    }
    .pin, .pulse{
      position:absolute;
      left: 58%;
      top: 48%;
      z-index: 8;
    }
    .pin{
      width: 44px;
      height: 44px;
      transform: translate(-50%,-100%);
      display:grid;
      place-items:center;
      font-size: 40px;
      text-shadow: 0 0 18px rgba(255,210,106,.35);
      filter:
        drop-shadow(0 14px 32px rgba(0,0,0,.65))
        drop-shadow(0 0 18px rgba(255,210,106,.22));
      animation: pinBounce 1.2s ease-in-out infinite;
      transform-origin: 50% 90%;
    }
    @keyframes pinBounce{
      0%,100%{ transform: translate(-50%,-100%) scale(1); }
      50%{ transform: translate(-50%,-106%) scale(1.05); }
    }
    @media (prefers-reduced-motion: reduce){
      .pin{ animation:none; }
    }
    .pulse{
      width: 28px;
      height: 28px;
      transform: translate(-50%,-50%);
      border-radius: 999px;
      border: 1px solid rgba(255,210,106,.75);
      box-shadow: 0 0 26px rgba(255,210,106,.22);
      animation: pulse 1.6s ease-in-out infinite;
    }
    @keyframes pulse{
      0%{ transform: translate(-50%,-50%) scale(.9); opacity:.85; }
      70%{ transform: translate(-50%,-50%) scale(2.7); opacity:0; }
      100%{ opacity:0; }
    }
    @media (prefers-reduced-motion: reduce){
      .pulse{ animation:none; opacity:.7; transform: translate(-50%,-50%) scale(1.7); }
    }
    .maptext{
      padding: 14px 14px 0 14px;
      text-align:center;
    }
    .maptext h2{
      margin: 10px 0 6px 0;
      font-size: 20px;
      letter-spacing: -0.01em;
    }
    .maptext p{
      margin: 0 0 12px 0;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.45;
    }

    /* ==========================
       MODAL (FIXED: phone fit)
    =========================== */
    .modal{
      position: fixed;
      inset: 0;
      z-index: 120;
      display:none;

      /* bottom sheet */
      align-items: flex-end;
      justify-content: center;

      padding: 0 12px calc(10px + var(--safe-bottom)) 12px;

      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .modal.show{ display:flex; }

    .sheet{
      width: min(520px, 96vw);
      border-radius: 26px 26px 20px 20px;

      /* IMPORTANT: never exceed screen height */
      max-height: calc(92svh - var(--safe-top));
      height: auto;

      background: linear-gradient(180deg, rgba(255,255,255,.11), rgba(255,255,255,.06));
      border: 1px solid rgba(255,255,255,.16);
      box-shadow: var(--shadow);
      overflow:hidden;

      transform: translateY(14px);
      opacity: 0;
      animation: sheetIn 260ms cubic-bezier(.2,.9,.2,1) forwards;
      position: relative;

      display:flex;
      flex-direction:column;
    }
    @keyframes sheetIn{ to{ transform: translateY(0); opacity:1; } }

    .sheet::before{
      content:"";
      position:absolute; inset:0;
      background: repeating-linear-gradient(
        to bottom,
        rgba(255,255,255,.05) 0px,
        rgba(255,255,255,.05) 1px,
        transparent 3px,
        transparent 7px
      );
      opacity:.08;
      pointer-events:none;
    }

    .sheet-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: 14px 14px 8px 14px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      position: relative;
      z-index: 3;
      flex: 0 0 auto;
    }
    .sheet-title{ font-weight: 950; letter-spacing: -0.01em; }
    .xbtn{
      width: 42px; height: 42px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.9);
      cursor:pointer;
      font-weight: 900;
    }
    .xbtn:active{ transform: scale(.98); }

    .sheet-body{
      overflow: auto;                 /* scroll inside */
      -webkit-overflow-scrolling: touch;
      padding: 14px;
      display:flex;
      flex-direction:column;
      gap: 12px;
      align-items:center;
      position: relative;
      z-index: 3;
      flex: 1 1 auto;
    }

    .sheet-help{
      text-align:center;
      color: rgba(255,255,255,.80);
      font-size: 14px;
      line-height: 1.4;
      min-height: 20px;
    }

    .sheet-actions{
      position: sticky;
      bottom: 0;
      background: linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.22));
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      padding: 10px 14px calc(14px + var(--safe-bottom)) 14px;
      border-top: 1px solid rgba(255,255,255,.10);
      z-index: 4;
      flex: 0 0 auto;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .ring{
      width: 92px;
      height: 92px;
      border-radius: 999px;
      position: relative;
      display:grid;
      place-items:center;
      background: radial-gradient(circle at 50% 50%, rgba(0,0,0,.25), rgba(0,0,0,.05));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .ring::before{
      content:"";
      position:absolute; inset:-2px;
      background: conic-gradient(rgba(255,210,106,.95) var(--p, 0%), rgba(255,255,255,.08) 0);
      mask: radial-gradient(circle, transparent 55%, #000 56%);
      -webkit-mask: radial-gradient(circle, transparent 55%, #000 56%);
      filter: drop-shadow(0 0 16px rgba(255,210,106,.20));
    }
    .ring span{
      position:relative;
      font-weight: 950;
      color: rgba(255,255,255,.85);
      font-size: 14px;
      letter-spacing: .01em;
    }

    .result{
      width: min(520px, 92vw);
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      padding: 14px 12px;
      text-align:center;
      display:none;
      box-shadow: var(--shadow2);
      position: relative;
      overflow:hidden;
    }
    .result.show{ display:block; }
    .result-title{
      font-weight: 1000;
      letter-spacing: -.02em;
      margin: 0 0 6px 0;
      font-size: 16px;
      color: rgba(255,255,255,.92);
    }
    .result-level{
      margin: 0;
      font-weight: 1000;
      font-size: 32px;
      letter-spacing: -0.03em;
      color: rgba(255,210,106,.95);
      text-shadow: 0 0 18px rgba(255,210,106,.18);
    }
    .result-sub{
      margin: 8px 0 0 0;
      color: rgba(255,255,255,.75);
      font-size: 13px;
      line-height: 1.35;
    }

    .confetti{
      position:absolute; inset:0;
      pointer-events:none;
      overflow:hidden;
      z-index: 4;
    }
    .c{
      position:absolute;
      font-size: 16px;
      opacity:0;
      animation: conf 1100ms ease-out forwards;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.25));
    }
    @keyframes conf{
      0%{ transform: translate3d(0,20px,0) scale(.7); opacity:0; }
      12%{ opacity:.95; }
      100%{ transform: translate3d(var(--dx), var(--dy), 0) rotate(18deg) scale(1.05); opacity:0; }
    }

    /* ===== Fingerprint area (adaptive) ===== */
    .fp-wrap{
      width: min(520px, 92vw);
      height: clamp(160px, 24vh, 240px); /* PHONE FIX */
      border-radius: 24px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      box-shadow: var(--shadow2);
      display:grid;
      place-items:center;
      position: relative;
      overflow:hidden;
      margin-top: 2px;
    }

    .fp-bg{
      position:absolute; inset:0;
      background:
        radial-gradient(420px 260px at 50% 40%, rgba(255,210,106,.10), transparent 60%),
        radial-gradient(420px 260px at 50% 60%, rgba(255,207,184,.06), transparent 62%),
        linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      opacity:.9;
      pointer-events:none;
    }

    .fingerprint{
      width: min(170px, 46vw);
      height: min(210px, 56vw);
      position: relative;
      filter: drop-shadow(0 0 16px rgba(255,210,106,.12));
      opacity: .88;
    }
    .fingerprint svg{ width: 100%; height: 100%; display:block; }

    .fp-line{
      fill:none;
      stroke: rgba(255,210,106,.55);
      stroke-width: 2.2;
      stroke-linecap: round;
      stroke-linejoin: round;
      opacity:.0;
      stroke-dasharray: 260;
      stroke-dashoffset: 260;
      animation: fpDraw 1.2s ease forwards;
      filter: drop-shadow(0 0 8px rgba(255,210,106,.10));
    }
    .fingerprint.idle .fp-line{
      opacity:.18;
      stroke-dashoffset: 0;
      animation:none;
    }
    .fingerprint.scanning .fp-line{
      opacity:.95;
      animation: fpDraw 1.1s ease forwards, fpGlow 720ms ease-in-out infinite;
    }
    @keyframes fpDraw{ to{ stroke-dashoffset: 0; } }
    @keyframes fpGlow{
      0%,100%{ filter: drop-shadow(0 0 8px rgba(255,210,106,.12)); }
      50%{ filter: drop-shadow(0 0 18px rgba(255,210,106,.22)); }
    }

    .fp-shine{
      position:absolute;
      inset:-60% -60%;
      background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,.22) 45%, rgba(255,255,255,.06) 55%, transparent 100%);
      transform: rotate(14deg) translateX(-60%);
      opacity:0;
      pointer-events:none;
    }
    .fingerprint.scanning + .fp-shine{
      opacity: .55;
      animation: fpShine 1.2s ease-in-out infinite;
    }
    @keyframes fpShine{
      0%{ transform: rotate(14deg) translateX(-60%); opacity:0; }
      20%{ opacity:.55; }
      100%{ transform: rotate(14deg) translateX(60%); opacity:0; }
    }

    .touch-blob{
      position:absolute;
      width: 58px;
      height: 58px;
      border-radius: 999px;
      background: radial-gradient(circle, rgba(255,210,106,.25), rgba(255,210,106,.06) 55%, transparent 70%);
      opacity:0;
      transform: translate(-50%,-50%) scale(.9);
      pointer-events:none;
      filter: blur(.1px);
    }
    .touch-blob.show{
      opacity:1;
      animation: blobPulse .8s ease-in-out infinite;
    }
    @keyframes blobPulse{
      0%,100%{ transform: translate(-50%,-50%) scale(.92); }
      50%{ transform: translate(-50%,-50%) scale(1.06); }
    }

    .scanbar{
      position:absolute;
      left: 10px;
      right: 10px;
      height: 4px;
      top: 12px;
      border-radius: 999px;
      overflow:hidden;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.10);
      opacity:.0;
      transform: translateY(-6px);
      transition: opacity .2s ease, transform .2s ease;
    }
    .scanbar.show{
      opacity:.95;
      transform: translateY(0);
    }
    .scanbar::before{
      content:"";
      position:absolute;
      inset:0;
      background: linear-gradient(90deg, transparent, rgba(255,210,106,.8), transparent);
      transform: translateX(-70%);
      animation: bar 1.0s ease-in-out infinite;
    }
    @keyframes bar{
      0%{ transform: translateX(-70%); opacity:0; }
      25%{ opacity:.9; }
      100%{ transform: translateX(70%); opacity:0; }
    }
  </style>
</head>

<body>
<div class="app">
  <div class="vignette"></div>

  <div class="topbar">
    <div class="brand">–ë–Ü–† –ê–î–ê–ú“í–ê</div>
    <div class="mute" id="muteBtn" aria-label="–î—ã–±—ã—Å" role="button" tabindex="0">üîá</div>
  </div>

  <div class="screens" id="screens">

    <!-- Screen 1 -->
    <section class="screen active" data-screen="0">
      <div class="hero">
        <div class="flowers" id="flowers"></div>
        <div class="glass-circle fadein">
          <img class="avatar" src="assets/avatar.webp" alt="–ê–≤–∞—Ç–∞—Ä" loading="eager" />
        </div>
      </div>

      <div class="copy fadein">
        <h1>–ë“±–ª —Å–∞–π—Ç ‚Äî —Ç–µ–∫ —Å–∞“ì–∞–Ω “ì–∞–Ω–∞ –∞—Ä–Ω–∞–ª“ì–∞–Ω.</h1>
        <p>–ë—ñ—Ä —Å–µ–∫—É–Ω–¥‚Ä¶ –¥–∞–π—ã–Ω –±–æ–ª üòå</p>
        <div class="subtle">–ú—É–∑—ã–∫–∞ —Ç–µ–∫ ‚Äú–ë–∞—Å—Ç–∞—É‚Äù –±–∞—Å“õ–∞–Ω–¥–∞ “ì–∞–Ω–∞ “õ–æ—Å—ã–ª–∞–¥—ã.</div>
      </div>

      <div class="thumb">
        <button class="btn btn-primary glow shimmer" id="startBtn">–ë–ê–°–¢–ê–£</button>
      </div>
    </section>

    <!-- Screen 2 -->
    <section class="screen" data-screen="1">
      <div class="memories fadein" id="memories">
        <div class="hint" id="hint">
          –°—ã—Ä“ì—ã—Ç—Å–∞“£ ‚Äî –±–∞—Å“õ–∞ –µ—Å—Ç–µ–ª—ñ–∫. –ê–≤—Ç–æ–º–∞—Ç—Ç—ã –¥–∞ –∞—É—ã—Å–∞–¥—ã üôÇ <button id="hintOk">–¢“Ø—Å—ñ–Ω–¥—ñ–º</button>
        </div>

        <div class="carousel" id="carousel">
          <div class="slide kenburns">
            <img class="bg" src="assets/memory1.webp" alt="" loading="lazy">
            <img class="fg" src="assets/memory1.webp" alt="–ï—Å—Ç–µ–ª—ñ–∫ 1" loading="lazy">
          </div>
          <div class="slide">
            <img class="bg" src="assets/memory2.webp" alt="" loading="lazy">
            <img class="fg" src="assets/memory2.webp" alt="–ï—Å—Ç–µ–ª—ñ–∫ 2" loading="lazy">
          </div>
          <div class="slide">
            <img class="bg" src="assets/memory3.webp" alt="" loading="lazy">
            <img class="fg" src="assets/memory3.webp" alt="–ï—Å—Ç–µ–ª—ñ–∫ 3" loading="lazy">
          </div>
          <div class="slide">
            <img class="bg" src="assets/memory4.webp" alt="" loading="lazy">
            <img class="fg" src="assets/memory4.webp" alt="–ï—Å—Ç–µ–ª—ñ–∫ 4" loading="lazy">
          </div>
          <div class="slide">
            <img class="bg" src="assets/memory5.webp" alt="" loading="lazy">
            <img class="fg" src="assets/memory5.webp" alt="–ï—Å—Ç–µ–ª—ñ–∫ 5" loading="lazy">
          </div>
          <div class="slide">
            <img class="bg" src="assets/memory6.webp" alt="" loading="lazy">
            <img class="fg" src="assets/memory6.webp" alt="–ï—Å—Ç–µ–ª—ñ–∫ 6" loading="lazy">
          </div>
        </div>

        <div class="dots" id="dots"></div>
        <div class="particles" id="particles"></div>

        <div class="heart-wrap">
          <div class="heart-btn shimmer" id="heartBtn" role="button" tabindex="0" aria-label="–ñ“Ø—Ä–µ–∫—à–µ–ª–µ—Ä">
            <span>–ë—ñ–∑–¥—ñ“£ –µ“£ —Ç”ô—Ç—Ç—ñ —Å”ô—Ç—Ç–µ—Ä‚Ä¶</span>
            <span style="filter:drop-shadow(0 0 16px rgba(255,207,184,.25))">‚ù§</span>
          </div>
        </div>
      </div>

      <div class="thumb">
        <div class="navrow">
          <button class="btn btn-secondary" id="backFrom2">–ê—Ä—Ç“õ–∞</button>
          <button class="btn btn-primary" id="toTrapBtn">–ö–µ–ª–µ—Å—ñ</button>
        </div>
      </div>
    </section>

    <!-- Screen 3 -->
    <section class="screen" data-screen="2" id="screen3">
      <div class="trap-area">
        <div class="copy fadein">
          <h1>–°–µ–Ω ”ô–ª–µ–º–¥–µ–≥—ñ –µ“£ —Å“±–ª—É, –µ“£ –∞“õ—ã–ª–¥—ã ”ô—Ä—ñ –µ“£ —Ç–∞–ª–∞–Ω—Ç—Ç—ã “õ—ã–∑—Å—ã“£ –±–∞?</h1>
          <p>“ö–∞–∑—ñ—Ä —Ç–µ–∫ —à—ã–Ω–¥—ã“õ üòà</p>
        </div>

        <div class="trap-buttons fadein" id="trapBox">
          <div class="tooltip" id="noTip">‚Äú–ñ–û“ö‚Äù –±–∞—Ç—ã—Ä–º–∞—Å—ã‚Ä¶ “õ–∞—à—ã–ø –∫–µ—Ç—Ç—ñ üòå</div>
          <button class="btn btn-green yes shimmer" id="yesBtn">–ò”ò</button>
          <button class="btn btn-secondary no" id="noBtn">–ñ–û“ö</button>
        </div>
      </div>

      <div class="thumb">
        <button class="btn btn-secondary" id="backFrom3">–ê—Ä—Ç“õ–∞</button>
      </div>
    </section>

    <!-- Screen 4 -->
    <section class="screen" data-screen="3" id="screen4">
      <div class="scanner-wrap">
        <div class="copy fadein">
          <h1>–°“±–ª—É–ª—ã“õ —Å–∫–∞–Ω–µ—Ä—ñ</h1>
          <p>–¢–µ–∫—Å–µ—Ä—ñ–ø –∫”©—Ä–µ–π—ñ–∫‚Ä¶ –±—ñ—Ä–∞“õ —Å–µ–Ω –¥–∞–π—ã–Ω—Å—ã“£ –±–∞? üôÇ</p>
        </div>

        <div class="frame fadein" id="frame">
          <div class="grid"></div>
          <div class="scanline" id="scanline"></div>
        </div>

        <div class="status" id="status"></div>

        <button class="btn btn-primary glow shimmer fadein" id="openScannerBtn">–°–ö–ê–ù–ï–†–î–Ü –ê–®–£</button>
      </div>

      <div class="thumb">
        <div class="navrow">
          <button class="btn btn-secondary" id="backFrom4">–ê—Ä—Ç“õ–∞</button>
          <button class="btn btn-primary" id="toMapBtn">–ö–µ–ª–µ—Å—ñ</button>
        </div>
      </div>
    </section>

    <!-- Screen 5 -->
    <section class="screen" data-screen="4" id="screen5">
      <div class="mapcard fadein">
        <div class="map-embed">
          <iframe
            class="gmap"
            id="gmap"
            loading="lazy"
            referrerpolicy="no-referrer-when-downgrade"
            src="https://www.google.com/maps?q=43.238949,76.889709&z=16&output=embed"
            title="–ö–µ–∑–¥–µ—Å—É –æ—Ä–Ω—ã –∫–∞—Ä—Ç–∞—Å—ã"></iframe>

          <div class="pulse"></div>
          <div class="pin">üíõ</div>
        </div>

        <div class="maptext">
          <h2>–ú–µ–Ω —Å–µ–Ω—ñ –æ—Å—ã –∂–µ—Ä–¥–µ –∫“Ø—Ç–µ–º üíõ</h2>
          <p id="timeLine">–ë“Ø–≥—ñ–Ω 19:30</p>
        </div>
      </div>

      <div class="thumb">
        <button class="btn btn-primary glow shimmer" id="dirBtn">–ú–∞—Ä—à—Ä—É—Ç –∞—à—É</button>
        <button class="btn btn-secondary" id="copyBtn">–ú–µ–∫–µ–Ω–∂–∞–π–¥—ã –∫”©—à—ñ—Ä—É</button>
        <button class="btn btn-secondary" id="backFrom5">–ê—Ä—Ç“õ–∞</button>
      </div>
    </section>

  </div>

  <!-- Audio -->
  <audio id="music" preload="none" loop>
    <source src="assets/music.mp3" type="audio/mpeg">
  </audio>
  <audio id="click" preload="auto">
    <source src="assets/click.mp3" type="audio/mpeg">
  </audio>
  <audio id="win" preload="auto">
    <source src="assets/win.mp3" type="audio/mpeg">
  </audio>

  <!-- Scanner Modal -->
  <div class="modal" id="scannerModal" aria-hidden="true">
    <div class="sheet" role="dialog" aria-modal="true">
      <div class="confetti" id="confetti"></div>

      <div class="sheet-header">
        <div class="sheet-title">–°–∫–∞–Ω–µ—Ä–ª–µ—É —Ä–µ–∂–∏–º—ñ</div>
        <button class="xbtn" id="closeModalBtn" aria-label="–ñ–∞–±—É">‚úï</button>
      </div>

      <div class="sheet-body">
        <div class="sheet-help" id="modalHelp">–°–∞—É—Å–∞“ì—ã“£–¥—ã ‚ÄúHOLD‚Äù –±–∞—Ç—ã—Ä–º–∞—Å—ã–Ω–∞ –±–∞—Å—ã–ø —Ç“±—Ä üôÇ</div>

        <div class="fp-wrap" id="fpWrap">
          <div class="fp-bg"></div>
          <div class="scanbar" id="scanbar"></div>

          <div class="fingerprint idle" id="fingerprint" aria-hidden="true">
            <svg viewBox="0 0 200 260">
              <path class="fp-line" d="M100 28 C65 28, 38 58, 38 95 C38 142, 58 184, 100 232" />
              <path class="fp-line" d="M100 28 C135 28, 162 58, 162 95 C162 142, 142 184, 100 232" />
              <path class="fp-line" d="M100 46 C74 46, 56 68, 56 96 C56 132, 74 164, 100 206" />
              <path class="fp-line" d="M100 46 C126 46, 144 68, 144 96 C144 132, 126 164, 100 206" />
              <path class="fp-line" d="M100 66 C86 66, 76 78, 76 98 C76 122, 86 146, 100 170" />
              <path class="fp-line" d="M100 66 C114 66, 124 78, 124 98 C124 122, 114 146, 100 170" />
              <path class="fp-line" d="M100 88 C94 88, 90 94, 90 102 C90 112, 95 124, 100 136" />
              <path class="fp-line" d="M100 88 C106 88, 110 94, 110 102 C110 112, 105 124, 100 136" />
            </svg>
          </div>
          <div class="fp-shine" aria-hidden="true"></div>

          <div class="touch-blob" id="touchBlob" aria-hidden="true"></div>
        </div>

        <div style="display:flex; gap:12px; align-items:center;">
          <div class="ring" id="ring" style="--p:0%">
            <span id="ringText">0%</span>
          </div>
          <div style="text-align:left; max-width: 290px; color: rgba(255,255,255,.78); font-size:13px; line-height:1.35;">
            <div style="font-weight:950; color: rgba(255,255,255,.9); margin-bottom:4px;">–°–∫–∞–Ω–µ—Ä —Å—Ç–∞—Ç—É—Å:</div>
            <div id="miniStatus">–ö“Ø—Ç—ñ–ø —Ç“±—Ä‚Ä¶</div>
          </div>
        </div>

        <div class="frame" style="height:clamp(160px, 22vh, 210px)" id="modalFrame">
          <div class="grid"></div>
          <div class="scanline" id="modalScanline"></div>
        </div>

        <div class="result" id="resultBox">
          <p class="result-title" id="resultTitle">“ö–∞—Ç–µ –∞–Ω—ã“õ—Ç–∞–ª–¥—ã!</p>
          <p class="result-level" id="resultLevel">‚àû%</p>
          <p class="result-sub" id="resultSub">–°“±–ª—É–ª—ã“õ –¥–µ“£–≥–µ–π—ñ —à–µ–∫—Ç–µ–Ω –∞—Å—Ç—ã. –ñ“Ø–π–µ —à—ã–¥–∞–º–∞–¥—ã üôÇ</p>
        </div>
      </div>

      <div class="sheet-actions">
        <button class="btn btn-primary glow shimmer" id="holdToScanBtn">–ë–ê–°–´–ü –¢“∞–†–£ (HOLD)</button>
        <button class="btn btn-secondary" id="doneBtn" style="display:none">–ñ–∞–±—É</button>
      </div>
    </div>
  </div>
</div>

<script>
  const $ = (s, el=document) => el.querySelector(s);
  const $$ = (s, el=document) => Array.from(el.querySelectorAll(s));
  const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  // ===== Navigation =====
  const screensEl = $('#screens');
  const screenEls = $$('.screen');
  let current = 0;

  function setActive(idx){
    current = Math.max(0, Math.min(idx, screenEls.length - 1));
    screensEl.style.transform = `translate3d(${-current * 100}vw, 0, 0)`;
    screenEls.forEach((s,i)=> s.classList.toggle('active', i === current));
    if (current === 1) applyKenBurns();
  }
  function pushState(idx){
    history.pushState({screen: idx}, '', `#s${idx+1}`);
  }
  window.addEventListener('popstate', (e)=>{
    const idx = (e.state && typeof e.state.screen === 'number') ? e.state.screen : 0;
    setActive(idx);
    if (idx === 1) startAutoplay(); else stopAutoplay();
  });
  (function initFromHash(){
    const m = (location.hash || '').match(/^#s(\d)$/);
    const idx = m ? (parseInt(m[1],10)-1) : 0;
    history.replaceState({screen: idx}, '', `#s${idx+1}`);
    setActive(idx);
  })();

  // ===== Audio =====
  const music = $('#music');
  const click = $('#click');
  const win = $('#win');
  const muteBtn = $('#muteBtn');

  let muted = true;
  function setMuted(v){
    muted = v;
    music.muted = muted;
    click.muted = muted;
    win.muted = muted;
    muteBtn.textContent = muted ? 'üîá' : 'üîä';
  }
  setMuted(true);

  function haptic(ms=12){
    try{ if (navigator.vibrate) navigator.vibrate(ms); }catch{}
  }
  function playClick(){
    if (muted) return;
    try{ click.currentTime = 0; click.play(); }catch{}
  }
  async function fadeMusicTo(targetVol, ms=900){
    const steps = 20;
    const delta = (targetVol - music.volume) / steps;
    for (let i=0;i<steps;i++){
      music.volume = Math.max(0, Math.min(1, music.volume + delta));
      await new Promise(r => setTimeout(r, ms/steps));
    }
    music.volume = targetVol;
  }

  muteBtn.addEventListener('click', ()=>{
    setMuted(!muted);
    if (!muted && !music.paused) fadeMusicTo(1, 700);
  });
  muteBtn.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter' || e.key === ' ') muteBtn.click();
  });

  // ===== Screen 1 Flowers =====
  const flowers = $('#flowers');
  function spawnFlowers(){
    if (prefersReduced) return;
    const assets = [
      'assets/flower1.webp',
      'assets/flower2.webp',
      'assets/flower3.webp',
      'assets/flower4.webp'
    ].filter(Boolean);

    const count = 12;
    for (let i=0;i<count;i++){
      const img = document.createElement('img');
      img.className = 'flower';
      img.src = assets[i % assets.length] || 'assets/flower1.webp';
      img.alt = '';
      const left = Math.random() * 100;
      const dur = 8 + Math.random() * 8;
      const delay = Math.random() * 4;
      const size = 30 + Math.random() * 34;
      img.style.left = `${left}vw`;
      img.style.width = `${size}px`;
      img.style.height = `${size}px`;
      img.style.animationDuration = `${dur}s`;
      img.style.animationDelay = `${delay}s`;
      img.style.opacity = (0.55 + Math.random() * 0.35).toFixed(2);
      flowers.appendChild(img);
    }
  }
  spawnFlowers();

  $('#startBtn').addEventListener('click', async ()=>{
    haptic(14);
    playClick();

    if (muted) setMuted(false);
    try{
      music.volume = 0.0;
      await music.play();
      await fadeMusicTo(1.0, 900);
    }catch{}

    pushState(1);
    setActive(1);
    startAutoplay();
  });

  // ===== Screen 2 Carousel + autoplay =====
  const carousel = $('#carousel');
  const slides = $$('.slide', carousel);
  const dotsEl = $('#dots');
  const hint = $('#hint');
  const hintOk = $('#hintOk');
  const heartBtn = $('#heartBtn');
  const particles = $('#particles');
  const memories = $('#memories');

  let slideIndex = 0;
  let startX = 0, currentX = 0, dragging = false;
  let hintDismissed = false;

  let autoplayTimer = null;
  let autoplayPausedUntil = 0;
  const AUTOPLAY_MS = 4200;
  const RESUME_AFTER_MS = 7000;

  function buildDots(){
    dotsEl.innerHTML = '';
    slides.forEach((_, i)=>{
      const d = document.createElement('div');
      d.className = 'dot' + (i === slideIndex ? ' active' : '');
      dotsEl.appendChild(d);
      d.addEventListener('click', ()=> { pauseAutoplay(); goSlide(i); });
    });
  }
  function goSlide(i){
    slideIndex = Math.max(0, Math.min(i, slides.length - 1));
    carousel.style.transform = `translate3d(${-slideIndex * 100}%, 0, 0)`;
    $$('.dot', dotsEl).forEach((d, idx)=> d.classList.toggle('active', idx === slideIndex));
    applyKenBurns();
  }
  function applyKenBurns(){
    slides.forEach((s, i)=>{
      s.classList.toggle('kenburns', !prefersReduced && (i === slideIndex));
    });
  }
  function dismissHint(){
    if (hintDismissed) return;
    hintDismissed = true;
    hint.style.display = 'none';
  }
  hintOk.addEventListener('click', dismissHint);

  function pauseAutoplay(){
    autoplayPausedUntil = Date.now() + RESUME_AFTER_MS;
  }
  function startAutoplay(){
    stopAutoplay();
    autoplayTimer = setInterval(()=>{
      if (current !== 1) return;
      if (Date.now() < autoplayPausedUntil) return;
      goSlide((slideIndex + 1) % slides.length);
    }, AUTOPLAY_MS);
  }
  function stopAutoplay(){
    if (autoplayTimer) clearInterval(autoplayTimer);
    autoplayTimer = null;
  }

  function onDown(clientX){
    dragging = true;
    startX = clientX;
    currentX = clientX;
    carousel.style.transition = 'none';
  }
  function onMove(clientX){
    if (!dragging) return;
    currentX = clientX;
    const dx = currentX - startX;
    const pct = dx / memories.clientWidth * 100;
    carousel.style.transform = `translate3d(${-(slideIndex * 100) + pct}%, 0, 0)`;
  }
  function onUp(){
    if (!dragging) return;
    dragging = false;
    carousel.style.transition = 'transform 520ms cubic-bezier(.2,.9,.2,1)';
    const dx = currentX - startX;
    const threshold = memories.clientWidth * 0.16;

    if (dx < -threshold) goSlide(slideIndex + 1);
    else if (dx > threshold) goSlide(slideIndex - 1);
    else goSlide(slideIndex);

    dismissHint();
    pauseAutoplay();
  }

  heartBtn.addEventListener('touchstart', (e)=> e.stopPropagation(), {passive:true});
  heartBtn.addEventListener('pointerdown', (e)=> e.stopPropagation());
  memories.addEventListener('pointerdown', (e)=>{
    if (e.target.closest('#heartBtn')) return;
    onDown(e.clientX);
    pauseAutoplay();
  });
  window.addEventListener('pointermove', (e)=> onMove(e.clientX));
  window.addEventListener('pointerup', onUp);

  buildDots();
  goSlide(0);

  function spawnHearts(){
    if (prefersReduced) return;
    haptic(10);
    playClick();
    pauseAutoplay();

    heartBtn.classList.remove('pulsefx');
    void heartBtn.offsetWidth;
    heartBtn.classList.add('pulsefx');

    const n = 20 + Math.floor(Math.random() * 12);
    const rect = memories.getBoundingClientRect();
    for (let i=0;i<n;i++){
      const el = document.createElement('div');
      el.className = 'pheart';
      el.textContent = Math.random() > 0.2 ? '‚ù§' : 'üíõ';
      const x = rect.left + Math.random() * rect.width;
      const y = rect.top + rect.height * (0.55 + Math.random() * 0.35);
      const dx = (Math.random()*2 - 1) * 140;
      const dy = -(100 + Math.random() * 160);
      el.style.left = `${x - rect.left}px`;
      el.style.top  = `${y - rect.top}px`;
      el.style.setProperty('--dx', `${dx}px`);
      el.style.setProperty('--dy', `${dy}px`);
      particles.appendChild(el);
      el.addEventListener('animationend', ()=> el.remove());
    }
  }
  heartBtn.addEventListener('click', spawnHearts);

  // ===== Nav buttons =====
  $('#backFrom2').addEventListener('click', ()=>{ haptic(10); playClick(); pushState(0); setActive(0); stopAutoplay(); });
  $('#toTrapBtn').addEventListener('click', ()=>{ haptic(10); playClick(); pushState(2); setActive(2); stopAutoplay(); });
  $('#backFrom3').addEventListener('click', ()=>{ haptic(10); playClick(); pushState(1); setActive(1); startAutoplay(); });
  $('#backFrom4').addEventListener('click', ()=>{ haptic(10); playClick(); pushState(2); setActive(2); });
  $('#toMapBtn').addEventListener('click', ()=>{ haptic(10); playClick(); pushState(4); setActive(4); });
  $('#backFrom5').addEventListener('click', ()=>{ haptic(10); playClick(); pushState(3); setActive(3); });

  // ===== Screen 3 Trap =====
  const trapBox = $('#trapBox');
  const noBtn = $('#noBtn');
  const yesBtn = $('#yesBtn');
  const noTip = $('#noTip');

  let escapes = 0;
  let noGone = false;
  let chaseStartTs = 0;

  function rand(min, max){ return min + Math.random() * (max - min); }
  function moveNoButton(){
    if (noGone) return;
    const box = trapBox.getBoundingClientRect();
    const btnW = noBtn.offsetWidth;
    const btnH = noBtn.offsetHeight;
    const pad = 16;
    const maxX = box.width - btnW - pad;
    const maxY = box.height - btnH - pad;
    const x = rand(pad, Math.max(pad, maxX));
    const y = rand(pad, Math.max(pad, maxY));
    noBtn.style.left = `${x}px`;
    noBtn.style.top  = `${y}px`;
  }
  function distToNo(px, py){
    const r = noBtn.getBoundingClientRect();
    const cx = r.left + r.width/2;
    const cy = r.top + r.height/2;
    return Math.hypot(px - cx, py - cy);
  }
  function maybeEscape(clientX, clientY){
    if (noGone) return;
    if (!chaseStartTs) chaseStartTs = performance.now();
    const d = distToNo(clientX, clientY);
    if (d < 95){
      escapes++;
      moveNoButton();
      const t = performance.now() - chaseStartTs;
      const limit = 3 + Math.floor(Math.random()*3);
      if (escapes >= limit || t > 4000){
        noTip.classList.add('show');
        noBtn.style.transition = 'opacity 260ms ease, transform 260ms ease';
        noBtn.style.opacity = '0';
        noBtn.style.transform = 'scale(.85)';
        noGone = true;
        setTimeout(()=> noBtn.style.display = 'none', 300);
      }
    }
  }
  trapBox.addEventListener('pointermove', (e)=> maybeEscape(e.clientX, e.clientY));
  trapBox.addEventListener('touchstart', (e)=>{
    const t = e.touches && e.touches[0];
    if (t) maybeEscape(t.clientX, t.clientY);
  }, {passive:true});

  yesBtn.addEventListener('click', ()=>{
    haptic(18);
    playClick();
    if (!prefersReduced){
      const s3 = $('#screen3');
      s3.classList.remove('shake'); void s3.offsetWidth; s3.classList.add('shake');
    }
    pushState(3);
    setActive(3);
  });

  // ===== Scanner Modal + Fingerprint =====
  const openScannerBtn = $('#openScannerBtn');
  const scannerModal = $('#scannerModal');
  const closeModalBtn = $('#closeModalBtn');
  const doneBtn = $('#doneBtn');

  const ring = $('#ring');
  const ringText = $('#ringText');
  const miniStatus = $('#miniStatus');

  const modalFrame = $('#modalFrame');
  const modalScanline = $('#modalScanline');
  const resultBox = $('#resultBox');
  const resultTitle = $('#resultTitle');
  const resultLevel = $('#resultLevel');
  const resultSub = $('#resultSub');
  const confetti = $('#confetti');

  const fpWrap = $('#fpWrap');
  const fingerprint = $('#fingerprint');
  const scanbar = $('#scanbar');
  const touchBlob = $('#touchBlob');

  const holdToScanBtn = $('#holdToScanBtn');

  let holdTimer = null;
  let scanning = false;
  let scanDone = false;
  let scanRAF = null;

  function openModal(){
    scannerModal.classList.add('show');
    scannerModal.setAttribute('aria-hidden','false');

    scanDone = false;
    scanning = false;
    resultBox.classList.remove('show');
    confetti.innerHTML = '';
    ring.style.setProperty('--p', '0%');
    ringText.textContent = '0%';
    miniStatus.textContent = '–ö“Ø—Ç—ñ–ø —Ç“±—Ä‚Ä¶';
    modalScanline.style.opacity = '0';

    fingerprint.classList.remove('scanning');
    fingerprint.classList.add('idle');
    scanbar.classList.remove('show');
    touchBlob.classList.remove('show');

    holdToScanBtn.style.display = '';
    doneBtn.style.display = 'none';
  }
  function closeModal(){
    scannerModal.classList.remove('show');
    scannerModal.setAttribute('aria-hidden','true');
    scanning = false;
    clearTimeout(holdTimer);
    holdTimer = null;
    if (scanRAF) cancelAnimationFrame(scanRAF);
    scanRAF = null;

    fingerprint.classList.remove('scanning');
    fingerprint.classList.add('idle');
    scanbar.classList.remove('show');
    touchBlob.classList.remove('show');
  }

  openScannerBtn.addEventListener('click', ()=>{ haptic(10); playClick(); openModal(); });
  closeModalBtn.addEventListener('click', ()=>{ haptic(10); playClick(); closeModal(); });
  doneBtn.addEventListener('click', ()=>{ haptic(10); playClick(); closeModal(); });

  scannerModal.addEventListener('click', (e)=>{
    if (e.target === scannerModal) closeModal();
  });

  function setBlob(x, y){
    const r = fpWrap.getBoundingClientRect();
    const lx = Math.max(12, Math.min(r.width-12, x - r.left));
    const ly = Math.max(12, Math.min(r.height-12, y - r.top));
    touchBlob.style.left = lx + 'px';
    touchBlob.style.top  = ly + 'px';
  }
  fpWrap.addEventListener('pointerdown', (e)=>{
    setBlob(e.clientX, e.clientY);
    touchBlob.classList.add('show');
  });
  fpWrap.addEventListener('pointermove', (e)=>{
    if (!touchBlob.classList.contains('show')) return;
    setBlob(e.clientX, e.clientY);
  });
  fpWrap.addEventListener('pointerup', ()=> touchBlob.classList.remove('show'));
  fpWrap.addEventListener('pointerleave', ()=> touchBlob.classList.remove('show'));

  function setRing(pct){
    const p = Math.max(0, Math.min(100, pct));
    ring.style.setProperty('--p', `${p}%`);
    ringText.textContent = `${Math.round(p)}%`;
  }
  function animateCount(from, to, ms, onUpdate, onDone){
    const start = performance.now();
    function tick(now){
      const t = Math.min(1, (now - start) / ms);
      const eased = 1 - Math.pow(1 - t, 3);
      const v = Math.floor(from + (to - from) * eased);
      onUpdate(v, t);
      if (t < 1) requestAnimationFrame(tick);
      else onDone && onDone();
    }
    requestAnimationFrame(tick);
  }
  function spawnConfettiHearts(){
    if (prefersReduced) return;
    const rect = resultBox.getBoundingClientRect();
    const n = 26;
    for (let i=0;i<n;i++){
      const el = document.createElement('div');
      el.className = 'c';
      el.textContent = Math.random() > 0.5 ? 'üíõ' : '‚ù§';
      const x = rect.width/2 + (Math.random()*2-1)*40;
      const y = 56 + Math.random()*20;
      const dx = (Math.random()*2 - 1) * 200;
      const dy = -(130 + Math.random() * 170);
      el.style.left = x + 'px';
      el.style.top  = y + 'px';
      el.style.setProperty('--dx', dx + 'px');
      el.style.setProperty('--dy', dy + 'px');
      confetti.appendChild(el);
      el.addEventListener('animationend', ()=> el.remove());
    }
  }

  function startScan(){
    if (scanDone) return;
    scanning = true;
    haptic(18);
    miniStatus.textContent = '–°–∫–∞–Ω–µ—Ä –±–∞—Å—Ç–∞–ª–¥—ã‚Ä¶';

    fingerprint.classList.remove('idle');
    fingerprint.classList.add('scanning');
    scanbar.classList.add('show');
    touchBlob.classList.add('show');

    const r = fpWrap.getBoundingClientRect();
    touchBlob.style.left = (r.width/2) + 'px';
    touchBlob.style.top  = (r.height/2) + 'px';

    setRing(0);
    modalScanline.style.opacity = '1';
    modalScanline.style.transition = 'none';
    modalScanline.style.transform = 'translateY(0px)';

    const h = modalFrame.clientHeight;
    const duration = 1500;
    const start = performance.now();

    function tick(now){
      if (!scanning) return;
      const t = (now - start) / duration;
      const s = Math.min(1, t);
      const y = Math.sin(s * Math.PI) * (h * 0.72);
      modalScanline.style.transform = `translateY(${y}px)`;
      scanRAF = requestAnimationFrame(tick);
    }
    scanRAF = requestAnimationFrame(tick);

    animateCount(0, 96, 1400, (v)=>{
      setRing(v);
      if (v < 30) miniStatus.textContent = '–î–µ—Ä–µ–∫ –∂–∏–Ω–∞–ª—ã–ø –∂–∞—Ç—ã—Ä‚Ä¶';
      else if (v < 70) miniStatus.textContent = '–¢–µ–∫—Å–µ—Ä—É: OK ‚úÖ';
      else miniStatus.textContent = '‚Ä¶–®–µ–∫–∫–µ –∂–µ—Ç—ñ–ø “õ–∞–ª–¥—ã‚Ä¶';
    });

    const needed = 1200 + Math.random() * 650;
    holdTimer = setTimeout(()=> finishScan(), needed);
  }

  function cancelScanEarly(){
    if (scanDone) return;
    if (!scanning) return;
    scanning = false;
    clearTimeout(holdTimer);
    holdTimer = null;
    if (scanRAF) cancelAnimationFrame(scanRAF);
    scanRAF = null;

    modalScanline.style.opacity = '0';
    miniStatus.textContent = '–¢–∞“ì—ã —Å”ô–ª “±—Å—Ç–∞–ø —Ç“±—Ä üôÇ';
    setRing(0);

    fingerprint.classList.remove('scanning');
    fingerprint.classList.add('idle');
    scanbar.classList.remove('show');
    touchBlob.classList.remove('show');
  }

  function finishScan(){
    scanning = false;
    scanDone = true;
    clearTimeout(holdTimer);
    holdTimer = null;
    if (scanRAF) cancelAnimationFrame(scanRAF);
    scanRAF = null;

    modalScanline.style.opacity = '0';

    scanbar.classList.remove('show');
    touchBlob.classList.remove('show');
    fingerprint.classList.remove('scanning');
    fingerprint.classList.add('idle');

    setRing(100);
    miniStatus.textContent = '‚Ä¶“ö–∞—Ç–µ! –®–µ–∫ –±“±–∑—ã–ª–¥—ã.';

    modalFrame.classList.remove('glitch'); void modalFrame.offsetWidth; modalFrame.classList.add('glitch');

    resultTitle.textContent = '“ö–∞—Ç–µ! –ñ“Ø–π–µ –∫”©—Ç–µ—Ä–µ –∞–ª–º–∞–¥—ã üòå';
    resultSub.textContent = '–°“±–ª—É–ª—ã“õ –¥–µ“£–≥–µ–π—ñ —à–µ–∫—Ç–µ–Ω –∞—Å—Ç—ã ‚Äî –±“±–ª “õ–∞–ª—ã–ø—Ç—ã –µ–º–µ—Å üôÇ';
    resultBox.classList.add('show');

    resultLevel.textContent = '0%';
    animateCount(0, 9999, 900, (v)=>{
      resultLevel.textContent = v.toLocaleString('en-US') + '%';
      if (!prefersReduced && v % 900 === 0) haptic(8);
    }, ()=>{
      resultLevel.textContent = '‚àû%';
      spawnConfettiHearts();
      haptic(22);
      if (!muted){
        try{ win.currentTime = 0; win.play(); }catch{}
      }
    });

    holdToScanBtn.style.display = 'none';
    doneBtn.style.display = '';
  }

  holdToScanBtn.addEventListener('pointerdown', (e)=>{
    playClick();
    holdToScanBtn.setPointerCapture(e.pointerId);
    startScan();
  });
  holdToScanBtn.addEventListener('pointerup', cancelScanEarly);
  holdToScanBtn.addEventListener('pointercancel', cancelScanEarly);

  // ===== Map deep link + copy =====
  const LAT = 43.238949;
  const LNG = 76.889709;
  const ADDRESS_TEXT = '–ö–µ–∑–¥–µ—Å—É –æ—Ä–Ω—ã: (–æ—Å—ã–Ω–¥–∞ –º–µ–∫–µ–Ω–∂–∞–π –∂–∞–∑)';
  $('#dirBtn').addEventListener('click', ()=>{
    haptic(10);
    playClick();
    const url = `https://www.google.com/maps/dir/?api=1&destination=${LAT},${LNG}`;
    window.open(url, '_blank', 'noopener,noreferrer');
  });
  $('#copyBtn').addEventListener('click', async ()=>{
    haptic(10);
    playClick();
    const btn = $('#copyBtn');
    try{
      await navigator.clipboard.writeText(ADDRESS_TEXT);
      btn.textContent = '–ö”©—à—ñ—Ä—ñ–ª–¥—ñ ‚úì';
      setTimeout(()=> btn.textContent = '–ú–µ–∫–µ–Ω–∂–∞–π–¥—ã –∫”©—à—ñ—Ä—É', 1300);
    }catch{
      const ta = document.createElement('textarea');
      ta.value = ADDRESS_TEXT;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
      btn.textContent = '–ö”©—à—ñ—Ä—ñ–ª–¥—ñ ‚úì';
      setTimeout(()=> btn.textContent = '–ú–µ–∫–µ–Ω–∂–∞–π–¥—ã –∫”©—à—ñ—Ä—É', 1300);
    }
  });

  // ===== Autoplay if starts on screen2 =====
  if (current === 1) startAutoplay();

  // avoid selection
  document.addEventListener('selectstart', (e)=> e.preventDefault());
</script>
</body>
</html>